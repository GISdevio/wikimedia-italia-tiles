services:
  postgres:
    build: services/postgres
    environment: &env
      POSTGRES_PASSWORD: test_password
      POSTGRES_USER: osm
      POSTGRES_DB: osm
      # https://www.postgresql.org/docs/current/libpq-envars.html
      PGHOST: postgres
      PGPASSWORD: test_password
      PGUSER: osm
      PGDATABASE: osm
    healthcheck:
      test: ["CMD", "pg_isready"]
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    #command: ["postgres", "-c", "log_statement=all"]
  external-data:
    build: services/external-data
    environment:
      <<: *env
    volumes:
      - ./data/external:/data
  osm2pgsql:
    build: services/osm2pgsql
    depends_on:
      - postgres
    environment:
      <<: *env
      REPLICATION_URL: "https://planet.openstreetmap.org/replication/day/"
      INITIAL_PBF: http://nginx/isole-latest.osm.pbf
#      INITIAL_PBF: http://download.geofabrik.de/europe/italy-latest.osm.pbf
  nginx:
    image: nginx:1.27
    volumes:
      - ./data/init:/usr/share/nginx/html:ro
  renderd:
    build:
      context: services/web
      dockerfile: renderd/Dockerfile
    depends_on:
      - postgres
    environment:
      <<: *env
    volumes:
      - ./data/tiles:/var/cache/renderd/tiles
      - ./data/layers_dummy:/syles/hiking/layers
  apache:
    build:
      context: services/web
      dockerfile: apache/Dockerfile
    depends_on:
      - renderd
    volumes:
      - ./data/tiles:/var/cache/renderd/tiles
    ports:
      - 8081:8081
